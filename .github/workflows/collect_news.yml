name: üì∞ Collect Daily News

on:
  schedule:
    - cron: "0 5 * * *"   # –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 05:00 UTC (06:00 –ø–æ –ë–µ–ª–≥—Ä–∞–¥—É)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  collect:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Collect and analyze news
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          REPORT_TELEGRAM_TOKEN: ${{ secrets.REPORT_TELEGRAM_TOKEN }}
          TELEGRAM_CHAT: ${{ secrets.TELEGRAM_CHAT }}
        run: |
          python main.py --collect-only

      - name: Commit updated selected.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            
            # –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º –ª—é–±—ã–µ –Ω–µ–∑–∞–∫–æ–º–º–∏—á–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (—á–∏—Å—Ç–∞—è –∫–æ–ø–∏—è —Ä–µ–ø–æ)
            git reset --hard
            git clean -fd
            
            # –ü–æ–¥—Ç—è–≥–∏–≤–∞–µ–º main –±–µ–∑ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
            git fetch origin main
            git checkout main
            git pull origin main
            
            # –î–æ–±–∞–≤–ª—è–µ–º –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π —Ñ–∞–π–ª
            git add -f data/selected.json
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ä–µ–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
            if git diff --cached --quiet; then
              echo "No changes in selected.json ‚Äî skipping commit"
            else
              git commit -m "update daily selected.json [skip ci]"
              git push https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git HEAD:main
              echo "‚úÖ selected.json pushed successfully"
            fi